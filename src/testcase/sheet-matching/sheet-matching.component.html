<div class="sheet-matching-container">
  <div class="sheet-header">
    <h2 class="sheet-title">
      <span class="material-icons">description</span>
      Mapping Sheet: <strong>{{ sheetName() }}</strong>
    </h2>
    <button (click)="goBack()" class="back-btn">
      <span class="material-icons">arrow_back</span>
      Back to Import
    </button>
  </div>

  <div *ngIf="errorMessage()" class="error-message">
    {{ errorMessage() }}
  </div>

  <div class="mapping-grid">
    <!-- Test Case Fields Column -->
    <div class="mapping-column">
      <div class="column-header">
        <h3 class="column-title">
          <span class="material-icons">label</span>
          Test Case Fields
        </h3>
        <span class="column-subtitle">{{ sheetColumns().length }} columns detected</span>
      </div>
      
      <div *ngFor="let field of allFields()" class="field-item" [class.mapped]="field.mappedTo">
        <div class="field-header">
          <div>
            <span class="field-name">{{ field.label }}</span>
            <span *ngIf="field.required" class="field-required">(required)</span>
            <span *ngIf="!field.required" class="field-optional">(optional)</span>
          </div>
          <span *ngIf="field.mappedTo" class="mapped-badge">Mapped</span>
        </div>
        
        <select
          class="field-select"
          [ngModel]="field.mappedTo"
          (ngModelChange)="field.field.startsWith('attr_') ? 
            updateAttributeMapping(field.label, $event) : 
            updateMapping(field.field, $event)"
        >
          <option value="">-- Select Column --</option>
          <option *ngFor="let col of sheetColumns()" [value]="col">{{ col }}</option>
        </select>
        
        <div *ngIf="field.example" class="field-example">
          Example: {{ field.example }}
        </div>

        <div *ngIf="field.field === 'moduleId' && field.mappedTo" class="auto-generated-hint">
          <span class="material-icons">auto_awesome</span>
          Auto-generated from sheet name
        </div>
      </div>

      <!-- Custom Attributes Section -->
      <div class="custom-attributes">
        <h4 class="column-title">
          <span class="material-icons">add_circle</span>
          Custom Attributes
        </h4>
        <div *ngFor="let attr of customAttributes()" class="custom-attribute-item">
          <span class="custom-attribute-name">{{ attr }}</span>
          <button (click)="removeCustomAttribute(attr)" class="remove-attr-btn">
            <span class="material-icons">delete</span>
          </button>
        </div>
        <button
          (click)="openAddAttributeDialog()"
          class="add-attribute-btn"
        >
          <span class="material-icons">add</span>
          Add Custom Attribute
        </button>
      </div>
    </div>

    <!-- Sheet Columns Column -->
    <div class="mapping-column">
      <h3 class="column-title">
        <span class="material-icons">grid_on</span>
        Sheet Columns
      </h3>
      <div cdkDropList class="columns-list" (cdkDropListDropped)="drop($event)">
        <div *ngFor="let col of sheetColumns()" cdkDrag class="sheet-column-item">
          <span class="material-icons">drag_indicator</span>
          {{ col }}
        </div>
      </div>
    </div>

    <!-- Preview Column -->
    <div class="mapping-column">
      <h3 class="column-title">
        <span class="material-icons">preview</span>
        Preview (First 3 Rows)
      </h3>
      
      <div *ngIf="previewData().length > 0" class="preview-table-container">
        <table class="preview-table">
          <thead>
            <tr>
              <th *ngFor="let field of allFields()" [class.mapped]="field.mappedTo">
                {{ field.label }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of previewData()">
              <td *ngFor="let field of allFields()">
                <div class="preview-cell" [title]="getPreviewValue(row, field.field)">
                  {{ getPreviewValue(row, field.field) }}
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div *ngIf="previewData().length === 0" class="empty-preview">
        <span class="material-icons">info</span>
        <p>No preview available</p>
        <p>Map some fields to see a preview</p>
      </div>
    </div>
  </div>

  <div class="action-buttons">
    <button
      (click)="saveMapping()"
      [disabled]="isSaving()"
      class="save-btn"
    >
      <span *ngIf="!isSaving()" class="material-icons">save</span>
      <span *ngIf="isSaving()" class="spinner material-icons">hourglass_top</span>
      {{ isSaving() ? 'Saving...' : 'Save Mapping' }}
    </button>
  </div>
</div>