<h2 class="text-center">Test Management</h2>

<!-- Module dropdown -->
<div class="form-group">
  <label>Select Module</label>
  <select [ngModel]="selectedModule()" (ngModelChange)="onModuleChange($event)" [ngModelOptions]="{standalone: true}">
    <option value="">-- Choose Module --</option>
    <option *ngFor="let m of modules" [value]="m.id">
      {{ m.name }}
    </option>
  </select>
</div>

<!-- Action buttons -->
<div class="action-buttons" *ngIf="selectedModule()">
  <button class="btn-view" (click)="showViewTestCases = true; showStartTesting = false">
    View Test Cases
  </button>
  <button class="btn-start" (click)="showStartTesting = true; showViewTestCases = false">
    Start Testing
  </button>
</div>

<!-- View Test Cases Section -->
<div *ngIf="showViewTestCases">
  <div class="form-group" *ngIf="availableVersions.length">
    <label>Select Version</label>
    <select [(ngModel)]="selectedVersion" (ngModelChange)="onVersionChange()" [ngModelOptions]="{standalone: true}">
      <option value="">-- Choose Version --</option>
      <option *ngFor="let v of availableVersions" [value]="v">
        {{ v }}
      </option>
    </select>
  </div>

  <div *ngIf="selectedVersion && versionTestCases().length">
    <h3>Test Cases for Version {{ selectedVersion }}</h3>
    
    <!-- Attribute filter -->
    <div class="filters">
      <input *ngIf="filter.attributeKey" type="text" placeholder="Attribute value" 
             [(ngModel)]="filter.attributeValue" [ngModelOptions]="{standalone: true}">
    </div>

    <div class="table-container">
      <table class="resizable-table">
        <thead>
          <tr>
            <th *ngFor="let col of viewColumns" 
                [style.width.px]="col.width" 
                (mousedown)="startResize($event, col)">
              {{ col.header }}
              <div class="resize-handle" *ngIf="!col.noResize"></div>
            </th>
            <th *ngFor="let col of attributeColumns" 
                [style.width.px]="col.width" 
                (mousedown)="startResize($event, col)">
              {{ col.header }}
              <div class="resize-handle"></div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tc of versionTestCases()">
            <td *ngFor="let col of viewColumns" class="wrap-text" [style.width.px]="col.width">
              {{ getCellValue(tc, col.field) }}
            </td>
            <td *ngFor="let col of attributeColumns" class="wrap-text" [style.width.px]="col.width">
              {{ getCellValue(tc, col.field) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Start Testing Section -->
<div *ngIf="showStartTesting">
  <!-- Filters -->
  <div class="filters" *ngIf="filteredTestCases().length">
    <input type="text" placeholder="Filter by Sl No" [(ngModel)]="filter.slNo" [ngModelOptions]="{standalone: true}">
    <input type="text" placeholder="Filter by TestCase ID" [(ngModel)]="filter.testCaseId" [ngModelOptions]="{standalone: true}">
    <input type="text" placeholder="Filter by Use Case" [(ngModel)]="filter.useCase" [ngModelOptions]="{standalone: true}">
    <select [(ngModel)]="filter.result" [ngModelOptions]="{standalone: true}">
      <option value="">All Results</option>
      <option value="Pass">Pass</option>
      <option value="Fail">Fail</option>
      <option value="Pending">others</option>
    </select>
    <select [(ngModel)]="filter.attributeKey" [ngModelOptions]="{standalone: true}">
      <option value="">-- Filter by Attribute --</option>
      <option *ngFor="let attr of availableAttributes" [value]="attr">{{ attr }}</option>
    </select>
    <input *ngIf="filter.attributeKey" type="text" placeholder="Attribute value" 
           [(ngModel)]="filter.attributeValue" [ngModelOptions]="{standalone: true}">
  </div>

  <!-- Test-case table -->
  <div *ngIf="filteredAndSearchedTestCases().length">
    <div class="table-container">
      <table class="resizable-table">
        <thead>
          <tr>
            <th *ngFor="let col of testColumns" 
                [style.width.px]="col.width" 
                (mousedown)="startResize($event, col)">
              {{ col.header }}
              <div class="resize-handle" *ngIf="!col.noResize"></div>
            </th>
            <th *ngFor="let col of attributeColumns" 
                [style.width.px]="col.width" 
                (mousedown)="startResize($event, col)">
              {{ col.header }}
              <div class="resize-handle"></div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tc of filteredAndSearchedTestCases(); let i = index" [formGroup]="formGroups()[i]">
            <td *ngFor="let col of testColumns" 
                class="wrap-text"
                [style.width.px]="col.width">
              <ng-container [ngSwitch]="col.field">
                <!-- Regular fields -->
                <ng-container *ngSwitchCase="'slNo'">{{ tc.slNo }}</ng-container>
                <ng-container *ngSwitchCase="'version'">{{ tc.version }}</ng-container>
                <ng-container *ngSwitchCase="'useCase'">{{ tc.useCase }}</ng-container>
                <ng-container *ngSwitchCase="'testCaseId'">{{ tc.testCaseId }}</ng-container>
                <ng-container *ngSwitchCase="'scenario'">{{ tc.scenario }}</ng-container>
                <ng-container *ngSwitchCase="'steps'">{{ tc.steps }}</ng-container>
                <ng-container *ngSwitchCase="'expected'">{{ tc.expected }}</ng-container>
                
                <!-- Special fields -->
                <ng-container *ngSwitchCase="'result'">
                  <select formControlName="result">
                    <option value="Pass">Pass</option>
                    <option value="Fail">Fail</option>
                    <option value="Pending"></option>
                  </select>
                </ng-container>
                
                <ng-container *ngSwitchCase="'actual'">
                  <div class="popup-cell" (click)="openPopup(i, 'actual', $event)">
                    <span>{{ getFormControl(i, 'actual').value || 'Click to enter' }}</span>
                    <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'actual'" class="popup-box">
                      <textarea [formControl]="getFormControl(i, 'actual')" rows="5" cols="40"></textarea>
                      <div class="popup-actions">
                        <button (click)="closePopup(i)">Save</button>
                      </div>
                    </div>
                  </div>
                </ng-container>
                
                <ng-container *ngSwitchCase="'remarks'">
                  <div class="popup-cell" (click)="openPopup(i, 'remarks', $event)">
                    <span>{{ getFormControl(i, 'remarks').value || 'Click to enter' }}</span>
                    <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'remarks'" class="popup-box">
                      <textarea [formControl]="getFormControl(i, 'remarks')" rows="5" cols="40"></textarea>
                      <div class="popup-actions">
                        <button (click)="closePopup(i)">Save</button>
                      </div>
                    </div>
                  </div>
                </ng-container>
                
                <ng-container *ngSwitchCase="'uploads'">
                  <input type="file" (change)="onUpload($event, i)" accept="image/*" multiple>
                  <div *ngFor="let file of uploads[i]" class="upload-preview">
                    <img [src]="file" alt="Uploaded Screenshot" width="50" height="50">
                  </div>
                </ng-container>
              </ng-container>
            </td>
            <td *ngFor="let col of attributeColumns" class="wrap-text" [style.width.px]="col.width">
              {{ getCellValue(tc, col.field) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button class="btn-save" (click)="onSave()">
      âœ… Save Results
    </button>
  </div>
</div>

<!-- Add Attribute Column Button -->
<div *ngIf="availableAttributes.length" class="add-attribute">
  <select #newAttribute>
    <option value="">-- Add Attribute Column --</option>
    <option *ngFor="let attr of availableAttributes" [value]="attr">{{ attr }}</option>
  </select>
  <button (click)="addAttributeColumn(newAttribute.value); newAttribute.value = ''">
    Add Column
  </button>
</div>