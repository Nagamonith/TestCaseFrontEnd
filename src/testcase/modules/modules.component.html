<h2 class="text-center">Test Management</h2>

<div class="container">
  <!-- Module dropdown -->
  <div class="form-group">
    <label>Select Module</label>
    <select [ngModel]="selectedModule()" (ngModelChange)="onModuleChange($event)" [ngModelOptions]="{standalone: true}">
      <option value="">-- Choose Module --</option>
      <option *ngFor="let m of modules" [value]="m.id">
        {{ m.name }}
      </option>
    </select>
  </div>

  <!-- Action buttons -->
  <div class="action-buttons" *ngIf="selectedModule()">
    <button class="btn-view" (click)="showViewTestCases = true; showStartTesting = false">
      View Test Cases
    </button>
    <button class="btn-start" (click)="showStartTesting = true; showViewTestCases = false">
      Start Testing
    </button>
  </div>

  <!-- View Test Cases Section -->
  <div *ngIf="showViewTestCases">
    <div class="form-group" *ngIf="availableVersions.length">
      <label>Select Version</label>
      <select [(ngModel)]="selectedVersion" (ngModelChange)="onVersionChange()" [ngModelOptions]="{standalone: true}">
        <option value="">-- Choose Version --</option>
        <option *ngFor="let v of availableVersions" [value]="v">
          {{ v }}
        </option>
      </select>
    </div>

    <div *ngIf="selectedVersion && versionTestCases().length">
      <h3>Test Cases for Version {{ selectedVersion }}</h3>
      <table>
        <thead>
          <tr>
            <th>Sl No</th>
            <th>Use Case</th>
            <th>Test Case ID</th>
            <th>Scenario</th>
            <th>Steps</th>
            <th>Expected</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tc of versionTestCases()">
            <td>{{ tc.slNo }}</td>
            <td class="wrap-text">{{ tc.useCase }}</td>
            <td>{{ tc.testCaseId }}</td>
            <td class="wrap-text">{{ tc.scenario }}</td>
            <td class="wrap-text">{{ tc.steps }}</td>
            <td class="wrap-text">{{ tc.expected }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Start Testing Section -->
  <div *ngIf="showStartTesting">
    <!-- Filters -->
    <div class="filters" *ngIf="filteredTestCases().length">
      <input type="text" placeholder="Filter by Sl No" [(ngModel)]="filter.slNo" [ngModelOptions]="{standalone: true}">
      <input type="text" placeholder="Filter by TestCase ID" [(ngModel)]="filter.testCaseId" [ngModelOptions]="{standalone: true}">
      <input type="text" placeholder="Filter by Use Case" [(ngModel)]="filter.useCase" [ngModelOptions]="{standalone: true}">
      <select [(ngModel)]="filter.result" [ngModelOptions]="{standalone: true}">
        <option value="">All Results</option>
        <option value="Pass">Pass</option>
        <option value="Fail">Fail</option>
        <option value="Pending">Pending</option>
      </select>
    </div>

    <!-- Test-case table -->
    <div *ngIf="filteredAndSearchedTestCases().length">
      <table>
        <thead>
          <tr>
            <th>Sl No</th>
            <th>Version</th>
            <th>Use Case</th>
            <th>Test Case ID</th>
            <th>Scenario</th>
            <th>Steps</th>
            <th>Expected</th>
            <th>Result</th>
            <th>Actual</th>
            <th>Remarks</th>
            <th>Uploads</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tc of filteredAndSearchedTestCases(); let i = index" [formGroup]="formGroups()[i]">
            <td>{{ tc.slNo }}</td>
            <td>{{ tc.version }}</td>
            <td class="wrap-text">{{ tc.useCase }}</td>
            <td>{{ tc.testCaseId }}</td>
            <td class="wrap-text">{{ tc.scenario }}</td>
            <td class="wrap-text">{{ tc.steps }}</td>
            <td class="wrap-text">{{ tc.expected }}</td>
            <td>
              <select formControlName="result">
                <option value="Pass">Pass ✅</option>
                <option value="Fail">Fail ❌</option>
                <option value="Pending">Pending ⏳</option>
              </select>
            </td>
            <td (click)="openPopup(i, 'actual', $event)" style="position: relative; cursor: pointer;">
              {{ getFormControl(i, 'actual').value }}
              <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'actual'" class="popup-box" (click)="$event.stopPropagation()">
                <textarea [formControl]="getFormControl(i, 'actual')" (blur)="closePopup(i)" autofocus rows="5" cols="40"></textarea>
                <button (click)="closePopup(i)">Save</button>
              </div>
            </td>
            <td (click)="openPopup(i, 'remarks', $event)" style="position: relative; cursor: pointer;">
              {{ getFormControl(i, 'remarks').value }}
              <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'remarks'" class="popup-box" (click)="$event.stopPropagation()">
                <textarea [formControl]="getFormControl(i, 'remarks')" (blur)="closePopup(i)" autofocus rows="5" cols="40"></textarea>
                <button (click)="closePopup(i)">Save</button>
              </div>
            </td>
            <td>
              <input type="file" (change)="onUpload($event, i)" accept="image/*" multiple>
              <div *ngFor="let file of uploads[i]" class="upload-preview">
                <img [src]="file" alt="Uploaded Screenshot" width="50" height="50">
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <button class="btn-save" (click)="onSave()">
        ✅ Save Results
      </button>
    </div>
  </div>
</div>