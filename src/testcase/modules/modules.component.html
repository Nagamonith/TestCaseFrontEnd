<h2 class="text-center">Test Management</h2>

<!-- Module dropdown -->
<div class="form-group">
  <label>Select Module</label>
  <select class="select-dropdown"
          [ngModel]="selectedModule()"
          (ngModelChange)="onModuleChange($event)"
          [ngModelOptions]="{standalone: true}">
    <option value="">-- Choose Module --</option>
    <option *ngFor="let m of modules" [value]="m.id">{{ m.name }}</option>
  </select>
</div>

<!-- Action buttons -->
<div class="action-buttons" *ngIf="selectedModule()">
  <button class="btn-view" (click)="showViewTestCases = true; showStartTesting = false">View Test Cases</button>
  <button class="btn-start" (click)="showStartTesting = true; showViewTestCases = false">Start Testing</button>
</div>

<!-- View Test Cases Section -->
<div *ngIf="showViewTestCases">
  <div class="form-group" *ngIf="availableVersions.length">
    <label>Select Version</label>
    <select [(ngModel)]="selectedVersion" (ngModelChange)="onVersionChange()" [ngModelOptions]="{standalone: true}">
      <option value="">-- Choose Version --</option>
      <option *ngFor="let v of availableVersions" [value]="v">{{ v }}</option>
    </select>
  </div>

  <div *ngIf="selectedVersion && versionTestCases().length">
    <h3>Test Cases for Version {{ selectedVersion }}</h3>

    <!-- Attribute filter -->
    <div class="filters">
      <input *ngIf="filter.attributeKey" type="text" placeholder="Attribute value"
             [(ngModel)]="filter.attributeValue" [ngModelOptions]="{standalone: true}">
    </div>

    <!-- Table with scroll -->
    <div class="table-scroll-container">
      <button class="scroll-button scroll-left" (click)="scrollTable(-200)" [class.hidden]="!canScrollLeft">&larr;</button>

      <div class="table-container" #tableContainer>
        <table class="resizable-table">
          <thead>
            <tr>
              <th *ngFor="let col of viewColumns"
                  [style.width.px]="col.width"
                  (mousedown)="startResize($event, col)">
                {{ col.header }}
                <div class="resize-handle" *ngIf="!col.noResize"></div>
              </th>
              <th *ngFor="let col of attributeColumns"
                  [style.width.px]="col.width"
                  (mousedown)="startResize($event, col)">
                {{ col.header }}
                <div class="resize-handle"></div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tc of versionTestCases()">
              <td *ngFor="let col of viewColumns" class="wrap-text" [style.width.px]="col.width">
                {{ getCellValue(tc, col.field) }}
              </td>
              <td *ngFor="let col of attributeColumns" class="wrap-text" [style.width.px]="col.width">
                {{ getCellValue(tc, col.field) }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="scroll-button scroll-right" (click)="scrollTable(200)" [class.hidden]="!canScrollRight">&rarr;</button>
    </div>
  </div>
</div>

<!-- Start Testing Section -->
<div *ngIf="showStartTesting">
  <!-- Filters -->
  <div class="filters" *ngIf="filteredTestCases().length">
    <input type="text" placeholder="Filter by Sl No" [(ngModel)]="filter.slNo" [ngModelOptions]="{standalone: true}">
    <input type="text" placeholder="Filter by TestCase ID" [(ngModel)]="filter.testCaseId" [ngModelOptions]="{standalone: true}">
    <input type="text" placeholder="Filter by Use Case" [(ngModel)]="filter.useCase" [ngModelOptions]="{standalone: true}">
    <select [(ngModel)]="filter.result" [ngModelOptions]="{standalone: true}">
      <option value="">All Results</option>
      <option value="Pass">Pass</option>
      <option value="Fail">Fail</option>
      <option value="Pending">others</option>
    </select>
    <select [(ngModel)]="filter.attributeKey" [ngModelOptions]="{standalone: true}">
      <option value="">-- Filter by Attribute --</option>
      <option *ngFor="let attr of availableAttributes" [value]="attr">{{ attr }}</option>
    </select>
    <input *ngIf="filter.attributeKey" type="text" placeholder="Attribute value"
           [(ngModel)]="filter.attributeValue" [ngModelOptions]="{standalone: true}">
  </div>

  <!-- Test Case Table -->
  <div *ngIf="filteredAndSearchedTestCases().length">
    <div class="table-scroll-container">
      <button class="scroll-button scroll-left" (click)="scrollTable(-200)" [class.hidden]="!canScrollLeft">&larr;</button>

      <div class="table-container" #tableContainer>
        <table class="resizable-table">
          <thead>
            <tr>
              <th class="copy-header"></th>
              <th *ngFor="let col of testColumns"
                  [style.width.px]="col.width"
                  (mousedown)="startResize($event, col)">
                {{ col.header }}
                <div class="resize-handle" *ngIf="!col.noResize"></div>
              </th>
              <th *ngFor="let col of attributeColumns"
                  [style.width.px]="col.width"
                  (mousedown)="startResize($event, col)">
                {{ col.header }}
                <div class="resize-handle"></div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let tc of filteredAndSearchedTestCases(); let i = index" [formGroup]="formGroups()[i]">
              <td class="copy-cell">
  <button 
  (click)="copyTestCaseLink(tc.testCaseId)"
  class="copy-btn"
  title="Copy test case link"
>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
          d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/>
  </svg>
</button>
</td>

              
              <td *ngFor="let col of testColumns" class="wrap-text" [style.width.px]="col.width">
                <ng-container [ngSwitch]="col.field">
                  <ng-container *ngSwitchCase="'slNo'">
                    {{ tc.slNo }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'version'">
                    {{ tc.version }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'useCase'">
                    {{ tc.useCase }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'testCaseId'">
                    {{ tc.testCaseId }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'scenario'">
                    {{ tc.scenario }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'steps'">
                    {{ tc.steps }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'expected'">
                    {{ tc.expected }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'actual'">
                    <div class="popup-cell" (click)="openPopup(i, 'actual', $event)">
                      <span>{{ getFormControl(i, 'actual').value || 'Click to enter' }}</span>
                      <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'actual'" class="popup-box">
                        <textarea [formControl]="getFormControl(i, 'actual')" rows="5" cols="40"></textarea>
                        <div class="popup-actions">
                          <button (click)="closePopup(i)">Save</button>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'remarks'">
                    <div class="popup-cell" (click)="openPopup(i, 'remarks', $event)">
                      <span>{{ getFormControl(i, 'remarks').value || 'Click to enter' }}</span>
                      <div *ngIf="isPopupOpen && popupIndex === i && popupField === 'remarks'" class="popup-box">
                        <textarea [formControl]="getFormControl(i, 'remarks')" rows="5" cols="40"></textarea>
                        <div class="popup-actions">
                          <button (click)="closePopup(i)">Save</button>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'result'">
                    <select formControlName="result">
                      <option value="Pass">Pass</option>
                      <option value="Fail">Fail</option>
                      <option value="Pending"></option>
                    </select>
                  </ng-container>

                  <ng-container *ngSwitchCase="'uploads'">
                    <input type="file" (change)="onUpload($event, i)" accept="image/*" multiple>
                    <div *ngFor="let file of uploads[i]" class="upload-preview">
                      <img [src]="file" alt="Uploaded Screenshot" width="50" height="50">
                    </div>
                  </ng-container>
                </ng-container>
              </td>

              <td *ngFor="let col of attributeColumns" class="wrap-text" [style.width.px]="col.width">
                {{ getCellValue(tc, col.field) }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="scroll-button scroll-right" (click)="scrollTable(200)" [class.hidden]="!canScrollRight">&rarr;</button>
    </div>

    <button class="btn-save" (click)="onSave()">âœ… Save Results</button>
  </div>
</div>

<!-- Add Attribute Column -->
<div *ngIf="availableAttributes.length" class="add-attribute">
  <select #newAttribute>
    <option value="">-- Add Attribute Column --</option>
    <option *ngFor="let attr of availableAttributes" [value]="attr">{{ attr }}</option>
  </select>
  <button (click)="addAttributeColumn(newAttribute.value); newAttribute.value = ''">Add Column</button>
</div>